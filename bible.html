<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Bible Verse Widget</title>
  <style>
    #bible-widget {
      font-family: 'Georgia', serif;
      font-style: italic;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      width: 300px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      margin: 20px auto;
      text-align: center;
    }
    #reference {
      text-align: right;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="bible-widget">
    <div id="verse">Loading today's verse...</div>
    <div id="reference"></div>
  </div>

  <script>
    const API_KEY = "76c644dd784f85ce960f161aa00f7ddb";
    const BIBLE_ID = "de4e12af7f28f599-02"; // KJV Bible ID
    const API_URL_BOOKS = `https://api.scripture.api.bible/v1/bibles/${BIBLE_ID}/books`;

    // Function to get today's date in EST
    function getTodayEST() {
      const now = new Date();
      // Convert current time to EST
      const utcOffset = now.getTimezoneOffset() * 60000; // in milliseconds
      const estOffset = -5 * 60 * 60 * 1000; // EST is UTC-5
      const estTime = new Date(now.getTime() + utcOffset + estOffset);
      return estTime.toISOString().split("T")[0]; // Returns date in YYYY-MM-DD format
    }

    async function fetchRandomVerse() {
      try {
        // Check if a verse is already stored for today
        const today = getTodayEST();
        const cachedVerse = JSON.parse(localStorage.getItem("dailyVerse"));
        if (cachedVerse && cachedVerse.date === today) {
          // Display cached verse
          document.getElementById("verse").textContent = cachedVerse.text;
          document.getElementById("reference").textContent = cachedVerse.reference;
          return;
        }

        // Step 1: Fetch all books
        const responseBooks = await fetch(API_URL_BOOKS, {
          headers: {
            "Authorization": `Bearer ${API_KEY}`
          }
        });
        if (!responseBooks.ok) {
          throw new Error("Failed to fetch books.");
        }
        const booksData = await responseBooks.json();
        const books = booksData.data;

        // Step 2: Select a random book
        const randomBook = books[Math.floor(Math.random() * books.length)];
        const API_URL_CHAPTERS = `https://api.scripture.api.bible/v1/bibles/${BIBLE_ID}/books/${randomBook.id}/chapters`;

        // Step 3: Fetch all chapters for the selected book
        const responseChapters = await fetch(API_URL_CHAPTERS, {
          headers: {
            "Authorization": `Bearer ${API_KEY}`
          }
        });
        if (!responseChapters.ok) {
          throw new Error("Failed to fetch chapters.");
        }
        const chaptersData = await responseChapters.json();
        const chapters = chaptersData.data;

        // Select a random chapter
        const randomChapter = chapters[Math.floor(Math.random() * chapters.length)];
        const API_URL_VERSES = `https://api.scripture.api.bible/v1/bibles/${BIBLE_ID}/chapters/${randomChapter.id}/verses`;

        // Step 4: Fetch all verses for the selected chapter
        const responseVerses = await fetch(API_URL_VERSES, {
          headers: {
            "Authorization": `Bearer ${API_KEY}`
          }
        });
        if (!responseVerses.ok) {
          throw new Error("Failed to fetch verses.");
        }
        const versesData = await responseVerses.json();
        const verses = versesData.data;

        // Select a random verse
        const randomVerse = verses[Math.floor(Math.random() * verses.length)];

        // Step 5: Display the verse and reference
        const verseText = randomVerse.reference;
        const verseReference = randomVerse.id;

        document.getElementById("verse").textContent = verseText;
        document.getElementById("reference").textContent = verseReference;

        // Cache the verse for today
        localStorage.setItem("dailyVerse", JSON.stringify({
          date: today,
          text: verseText,
          reference: verseReference
        }));

      } catch (error) {
        console.error("Error fetching Bible verse:", error);
        document.getElementById("verse").textContent = "Unable to load today's verse.";
        document.getElementById("reference").textContent = "";
      }
    }

    fetchRandomVerse();
  </script>
</body>
</html>
